<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ä¸‰æ¨¡å—æ‰“åˆ†ç³»ç»Ÿ</title>
  <style>
    body { font-family: Arial; margin: 20px; }
    button { margin: 10px 5px; padding: 5px 10px; }
    .card { border: 1px solid #ccc; padding: 15px; margin: 10px 0; }
    img {
      max-width: 200px;
      height: auto;
      display: block;
      margin: 10px auto;
      border-radius: 6px;
    }
    .nav-buttons { margin-top: 20px; }
    ul.sortable { list-style: none; padding: 0; }
    li.card { cursor: grab; }
  </style>
</head>
<body>

<h2>ä¸‰æ¨¡å—æ‰“åˆ†ç³»ç»Ÿ</h2>

<div id="moduleContainer"></div>

<div class="nav-buttons">
  <button id="prevBtn" onclick="prevModule()">ä¸Šä¸€é¡µ</button>
  <button id="nextBtn" onclick="nextModule()">ä¸‹ä¸€é¡µ</button>
  <button onclick="saveResults()">ä¿å­˜ç»“æœ</button>
</div>

<script>
let currentModule = 1;
let results = { module1: {}, module2: {}, module3: {} };
const totalModules = 3;
let module3Data = [];
let module3Groups = [];
let currentGroup = 0;
const groupSize = 5;

function loadModule(num) {
  currentModule = num;
  document.getElementById("prevBtn").disabled = currentModule === 1;
  document.getElementById("nextBtn").disabled = currentModule === totalModules;

  const file = `data_module${num}.json`;
  fetch(file)
    .then(res => res.json())
    .then(data => {
      if (num === 1) renderModule1(data);
      else if (num === 2) renderModule2(data);
      else if (num === 3) {
        module3Data = data;
        module3Groups = [];
        for (let i = 0; i < data.length; i += groupSize) {
          module3Groups.push(data.slice(i, i + groupSize));
        }
        currentGroup = 0;
        renderModule3Group();
      }
    });
}

function renderModule1(data) {
  const container = document.getElementById('moduleContainer');
  container.innerHTML = '<h3>æ¨¡å—ä¸€ï¼šå¯¹å•æ¡å†…å®¹æ‰“åˆ†ï¼ˆ0-4åˆ†ï¼‰</h3>';
  data.forEach(item => {
    const card = document.createElement('div');
    card.className = 'card';
    const imgHTML = getAllImages(item.image);
    card.innerHTML = `
      <p><strong>å•†å“åç§°ï¼š</strong>${item.name}</p>
      <p><strong>è¯„ä»·å†…å®¹ï¼š</strong>${item.text}</p>
      ${imgHTML}
      <label>æ‰“åˆ†ï¼š
        <select onchange="results.module1['${item.id}'] = this.value">
          <option value="">è¯·é€‰æ‹©</option>
          <option value="0">0åˆ†</option>
          <option value="1">1åˆ†</option>
          <option value="2">2åˆ†</option>
          <option value="3">3åˆ†</option>
          <option value="4">4åˆ†</option>
        </select>
      </label>
    `;
    container.appendChild(card);
  });
}

function renderModule2(data) {
  const container = document.getElementById('moduleContainer');
  container.innerHTML = '<h3>æ¨¡å—äºŒï¼šä¸¤æ¡å†…å®¹å¯¹æ¯”ï¼ˆé€‰æ‹©æ›´ä¼˜ï¼‰</h3>';
  data.forEach(pair => {
    const card = document.createElement('div');
    card.className = 'card';
    const imgA = getAllImages(pair.imageA);
    const imgB = getAllImages(pair.imageB);
    card.innerHTML = `
      <p><strong>å¯¹æ¯”ç»„IDï¼š${pair.id}</strong></p>
      <div>
        <input type="radio" name="pair${pair.id}" value="A" onchange="results.module2['${pair.id}'] = 'A'">
        <strong>A - ${pair.nameA}ï¼š</strong> ${pair.textA} <br>${imgA}
      </div>
      <div>
        <input type="radio" name="pair${pair.id}" value="B" onchange="results.module2['${pair.id}'] = 'B'">
        <strong>B - ${pair.nameB}ï¼š</strong> ${pair.textB} <br>${imgB}
      </div>
    `;
    container.appendChild(card);
  });
}

function renderModule3Group() {
  const container = document.getElementById('moduleContainer');
  container.innerHTML = `
    <h3>æ¨¡å—ä¸‰ï¼šæ‹–æ‹½æ’åºï¼ˆä»å¥½åˆ°å·®ï¼‰ - ç¬¬ ${currentGroup + 1} ç»„ / ${module3Groups.length}</h3>
    <ul id="sortableGroup" class="sortable"></ul>
    <div style="margin-top: 10px;">
      <button onclick="prevGroup()">ä¸Šä¸€ç»„</button>
      <button onclick="nextGroup()">ä¸‹ä¸€ç»„</button>
    </div>
  `;

  const ul = document.getElementById("sortableGroup");
  module3Groups[currentGroup].forEach(item => {
    const li = document.createElement('li');
    li.className = 'card';
    li.setAttribute('data-id', item.id);
    li.setAttribute('draggable', true);
    const imgHTML = getAllImages(item.image);
    li.innerHTML = `
      <p><strong>å•†å“åç§°ï¼š</strong>${item.name}</p>
      <p>${item.text}</p>
      ${imgHTML}
    `;
    ul.appendChild(li);
  });

  initDragSort("sortableGroup");
}

function initDragSort(listId) {
  const list = document.getElementById(listId);
  let draggedItem = null;

  list.querySelectorAll('.card').forEach(item => {
    item.addEventListener('dragstart', (e) => {
      draggedItem = item;
      e.dataTransfer.effectAllowed = 'move';
    });

    item.addEventListener('dragover', (e) => {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
    });

    item.addEventListener('drop', (e) => {
      e.preventDefault();
      if (draggedItem && draggedItem !== item) {
        list.insertBefore(draggedItem, item);
        saveCurrentGroupOrder();
      }
    });
  });
}

function saveCurrentGroupOrder() {
  const listItems = document.querySelectorAll('#sortableGroup .card');
  listItems.forEach((item, index) => {
    const id = item.getAttribute('data-id');
    results.module3[id] = index + 1;
  });
}

function prevGroup() {
  saveCurrentGroupOrder();
  if (currentGroup > 0) {
    currentGroup--;
    renderModule3Group();
  }
}

function nextGroup() {
  saveCurrentGroupOrder();
  if (currentGroup < module3Groups.length - 1) {
    currentGroup++;
    renderModule3Group();
  }
}

function prevModule() {
  if (currentModule > 1) loadModule(currentModule - 1);
}

function nextModule() {
  if (currentModule < totalModules) loadModule(currentModule + 1);
}

function validateAllModules() {
  return (
    Object.keys(results.module1).length > 0 &&
    Object.keys(results.module2).length > 0 &&
    Object.keys(results.module3).length > 0
  );
}

async function saveResults() {
  if (!validateAllModules()) {
    alert("è¯·å®Œæˆæ‰€æœ‰æ¨¡å—åå†ä¿å­˜ç»“æœï¼");
    return;
  }

  const [data1, data2, data3] = await Promise.all([
    fetch('data_module1.json').then(res => res.json()),
    fetch('data_module2.json').then(res => res.json()),
    fetch('data_module3.json').then(res => res.json())
  ]);

  const output = {
    module1: data1.map(item => ({
      id: item.id,
      name: item.name,
      score: results.module1[item.id] ?? null
    })),
    module2: data2.map(pair => ({
      id: pair.id,
      idA: pair.idA,
      nameA: pair.nameA,
      idB: pair.idB,
      nameB: pair.nameB,
      choice: results.module2[pair.id] ?? null
    })),
    module3: data3.map(item => ({
      id: item.id,
      name: item.name,
      rank: results.module3[item.id] ?? null
    }))
  };

  const blob = new Blob([JSON.stringify(output, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `Evaluate.json`;
  a.click();
}

// ğŸ”§ æ–°å¢ï¼šå±•ç¤ºå¤šå›¾è¾…åŠ©å‡½æ•°
function getAllImages(basePath) {
  if (!basePath) return "";
  const ext = basePath.endsWith(".jpg") ? ".jpg" : "";
  const prefix = basePath.replace(/_\d+\.jpg$/, "");
  const images = [];

  for (let i = 1; i <= 5; i++) {
    const imgPath = `${prefix}_${i}${ext}`;
    if (imageExists(imgPath)) {
      images.push(`<img src="${imgPath}" alt="å›¾${i}">`);
    }
  }

  return images.join("");
}

function imageExists(url) {
  const xhr = new XMLHttpRequest();
  xhr.open("HEAD", url, false); // åŒæ­¥
  try {
    xhr.send();
    return xhr.status !== 404;
  } catch (e) {
    return false;
  }
}

loadModule(currentModule);
</script>

</body>
</html>
